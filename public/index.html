<script>
// Convierte la imagen en Base64
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

async function sendImage() {
  const resultDiv = document.getElementById("result");
  const species = document.getElementById("species").value;
  const country = document.getElementById("country").value;
  const file = document.getElementById("imageInput").files[0];

  if (!file) {
    alert("Debes seleccionar una imagen primero.");
    return;
  }

  resultDiv.innerHTML = '<div class="loader"></div>';

  // Convertir imagen a base64
  const base64 = await toBase64(file);

  try {
    const res = await fetch("/api/diagnose", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        image: base64,
        species,
        country
      })
    });

    const data = await res.json();

    if (data.error) throw new Error(data.error);

    resultDiv.innerHTML = `
      <h3>Diagn√≥stico</h3>
      <p>${data.diagnosis}</p>
    `;

  } catch (err) {
    resultDiv.innerHTML = `<p style="color:red"><strong>Error:</strong> ${err.message}</p>`;
  }
}
</script>
