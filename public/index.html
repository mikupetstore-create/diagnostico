<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diagnóstico Veterinario</title>

  <style>
  body{font-family:Inter,system-ui,Arial;background:#fff;margin:0;padding:0;display:flex;align-items:center;justify-content:center;min-height:100vh}
  .card{width:100%;max-width:480px;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.07)}
  h1{margin:0 0 8px;font-size:20px}
  p{margin:0 0 12px;color:#555}
  .uploader{border:2px dashed #e6e6e6;padding:14px;border-radius:10px;text-align:center;cursor:pointer}
  input[type=file]{display:none}
  .preview{margin-top:12px;width:100%;height:260px;object-fit:cover;border-radius:8px}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:#06b6d4;color:#fff;border:0;cursor:pointer;margin-top:12px}
  .small{font-size:13px;color:#777;margin-top:8px}
  .results{margin-top:16px}
  .product{border:1px solid #eee;padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .product img{width:64px;height:64px;object-fit:cover;border-radius:6px}
  .loader{display:inline-block;border:4px solid #f3f3f3;border-top:4px solid #06b6d4;border-radius:50%;width:28px;height:28px;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
<body>
  <div class="container">
    <h1>Diagnóstico Veterinario</h1>

    <label>Especie:</label>
    <input type="text" id="species" placeholder="Ej: perro, gato" />

    <label>País:</label>
    <input type="text" id="country" placeholder="Ej: México, Colombia" />

    <label>Selecciona una imagen:</label>
    <input type="file" id="imageInput" accept="image/*" />

    <img id="preview" />

    <button onclick="sendImage()">Analizar Imagen</button>

    <div id="result"></div>
  </div>

  <script>
    // ✔ API fijada correctamente a la ruta de Next.js
    const API = "/api/diagnose";

    const preview = document.getElementById("preview");
    document.getElementById("imageInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
      }
    });

    async function sendImage() {
      const species = document.getElementById("species").value;
      const country = document.getElementById("country").value;
      const file = document.getElementById("imageInput").files[0];
      const resultDiv = document.getElementById("result");

      if (!file) {
        alert("Por favor selecciona una imagen primero.");
        return;
      }

      resultDiv.style.display = "block";
      resultDiv.innerHTML = "Analizando imagen...";

      const fd = new FormData();
      fd.append("image", file);
      fd.append("species", species);
      fd.append("country", country);

      try {
        const res = await fetch(API, {
          method: "POST",
          body: fd,
        });

        // Si la respuesta NO es JSON, lo capturamos antes de romper
        const contentType = res.headers.get("content-type");

        if (!contentType || !contentType.includes("application/json")) {
          const text = await res.text();
          throw new Error(
            "La API devolvió HTML en lugar de JSON. Respuesta:\n" + text
          );
        }

        const data = await res.json();

        if (data.error) {
          throw new Error(data.error);
        }

        resultDiv.innerHTML = `
          <strong>Resultado:</strong><br><br>
          <strong>Descripción:</strong> ${data.summary}<br><br>
          <strong>Severidad:</strong> ${data.severity}<br><br>
          <strong>Productos recomendados:</strong>
          <ul>
            ${data.recommendedProducts
              .map(
                (p) => `
              <li>
                <strong>${p.title}</strong><br>
                ${p.reason}<br>
                <a href="${p.affiliateLink}" target="_blank">Comprar</a>
              </li>
            `
              )
              .join("")}
          </ul>
        `;
      } catch (err) {
        resultDiv.innerHTML =
          "Error procesando la imagen: " + err.message;
      }
    }
  </script>
</body>
</html>
