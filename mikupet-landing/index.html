<script>
const photoInput = document.getElementById('photo');
const preview = document.getElementById('preview');
const uploaderText = document.getElementById('uploaderText');
const analyzeBtn = document.getElementById('analyzeBtn');
const status = document.getElementById('status');
const results = document.getElementById('results');
const species = document.getElementById('species');
const country = document.getElementById('country');

let fileBlob = null;

document.getElementById('uploader').addEventListener('click', ()=> photoInput.click());

photoInput.addEventListener('change', (ev)=>{
  const file = ev.target.files[0];
  if (!file) return;

  fileBlob = file;
  preview.src = URL.createObjectURL(file);
  preview.style.display = 'block';
  uploaderText.innerText = "Imagen lista";
  results.innerHTML = '';
});

analyzeBtn.addEventListener('click', async () => {
  if (!fileBlob) { alert("Sube una foto primero"); return; }

  status.innerHTML = '<span class="loader"></span> Analizando...';
  analyzeBtn.disabled = true;

  try {
    const fd = new FormData();
    fd.append("foto", fileBlob);
    fd.append("species", species.value);
    fd.append("country", country.value);

    // TU API DE VERCEL
    const API = "diagnostico-bmhqnzuu6-alexander-jaras-projects.vercel.app";

    const res = await fetch(API, { method:"POST", body: fd });
    const json = await res.json();

    if (!res.ok) {
      status.textContent = "Error analizando la imagen.";
      return;
    }

    renderResults(json);

  } catch (e) {
    status.textContent = "Error procesando la imagen.";
    console.error(e);
  }

  analyzeBtn.disabled = false;
});

function renderResults(data){
  status.textContent = "";

  if (data.error) {
    results.innerHTML = `<div style="color:#c00">${data.error}</div>`;
    return;
  }

  const { summary, severity, products } = data;

  let html = `
    <div><strong>Resultado:</strong> ${summary}</div>
    <div style="margin-top:6px"><strong>Nivel:</strong> ${severity}</div>
    <div style="margin-top:12px"><strong>Productos recomendados</strong></div>
  `;

  products.forEach(p => {
    html += `
      <div class="product">
        <div style="flex:1;margin-right:10px">
          <div style="font-weight:600">${p.title}</div>
          <div style="font-size:13px;color:#666">${p.reason}</div>
        </div>
        <a href="${p.link}" target="_blank"
          style="background:#06b6d4;color:#fff;padding:8px;border-radius:8px;text-decoration:none">
          Ver
        </a>
      </div>
    `;
  });

  results.innerHTML = html;
}
</script>
